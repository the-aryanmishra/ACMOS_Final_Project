* SYMMETRIC OTA TEMPLATE (User Verified Topology)
* ----------------------------------------------------

* 1. Circuit Topology (EXACTLY AS GENERATED BY LTSPICE)
M1 N003 N004 N006 N003 pmos292p l={L_in} w={W1}
M2 N003 N005 N007 N003 pmos292p l={L_in} w={W1}
M3 N006 N006 0 0 nmos292p l={L_mir} w={W3}
M4 N007 N007 0 0 nmos292p l={L_mir} w={W3}
M5 N001 N006 0 0 nmos292p l={L_mir} w={W5}
M6 n_out N007 0 0 nmos292p l={L_mir} w={W5}
M7 Vdd N001 N001 Vdd pmos292p l={L_mir} w={W7}
M8 Vdd N001 n_out Vdd pmos292p l={L_mir} w={W7}
M9 Vdd N002 N003 Vdd pmos292p l={L_mir} w={W9}
CLoad n_out 0 0.5p

* --- DYNAMIC VOLTAGE PARAMETERS ---
* Python replaces {VDD_VAL} with a number (e.g., 1.8).
.param SUPP = {VDD_VAL}

V1 Vdd 0 {SUPP}
* Input CM is half of supply (SUPP/2)
Vin- N004 0 {SUPP/2} AC 0.5 180
Vin+ N005 0 {SUPP/2} AC 0.5 0

M_bias Vdd N002 N002 Vdd pmos292p l={L_mir} w={W9}
Ibias N002 0 {I_BIAS_VAL}

* 2. Models
.model NMOS NMOS
.model PMOS PMOS
.include models_292p.txt

* ==========================================
* DESIGN PARAMETERS (Python Injection)
* ==========================================

* Fixed Lengths
.param L_in  = 0.5u
.param L_mir = 1.0u

* --- VARIABLES (Python will replace these curly braces) ---
.param W_in_gene   = {WIN}
.param W_load_gene = {WLOAD}
.param W_tail_gene = {WTAIL}
.param B_ratio     = {B_RATIO}
.param I_BIAS_VAL  = {IBIAS}

* --- LOGIC (Mapping Genes to Widths) ---
.param W1 = {W_in_gene}
.param W3 = {W_load_gene}
.param W5 = {W_load_gene * B_ratio}
.param W7 = {W_load_gene * B_ratio}
.param W9 = {W_tail_gene}

* ==========================================
* ANALYSIS & MEASUREMENTS
* ==========================================

* Run AC Analysis
.ac dec 50 1 10G

* Measure Results (Python reads these)
.meas ac DC_Gain MAX mag(V(n_out))
.meas ac BW WHEN mag(V(n_out))=(DC_Gain/1.414)
.meas ac Itotal AVG -I(V1)

.end

.save V(n_out)